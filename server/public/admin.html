<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tokenç®¡ç†å·¥å…·</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        padding: 40px 20px;
        max-width: 900px;
        margin: 0 auto;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
      }
      .container {
        background: white;
        border-radius: 16px;
        padding: 40px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      }
      h1 {
        color: #333;
        margin-bottom: 6px;
        font-size: 28px;
      }
      .subtitle {
        color: #666;
        margin-bottom: 30px;
        font-size: 14px;
      }

      /* ç»Ÿè®¡å¡ç‰‡ */
      .stats {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 15px;
        margin-bottom: 30px;
      }
      .stat-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 12px;
        text-align: center;
        cursor: pointer;
        transition:
          transform 0.2s,
          box-shadow 0.2s,
          opacity 0.2s;
        border: 3px solid transparent;
      }
      .stat-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
      }
      .stat-card.active {
        border-color: #fff;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.5);
      }
      .stat-card[data-status="unused"] {
        background: linear-gradient(135deg, #11998e, #38ef7d);
      }
      .stat-card[data-status="used"] {
        background: linear-gradient(135deg, #f7971e, #ffd200);
      }
      .stat-card[data-status="expired"] {
        background: linear-gradient(135deg, #cb2d3e, #ef473a);
      }
      .stat-number {
        font-size: 32px;
        font-weight: bold;
        margin-bottom: 4px;
      }
      .stat-label {
        font-size: 12px;
        opacity: 0.9;
      }

      /* è¡¨å• */
      .form-group {
        margin-bottom: 20px;
      }
      label {
        display: block;
        margin-bottom: 8px;
        color: #333;
        font-weight: 500;
      }
      input,
      select {
        width: 100%;
        padding: 12px 16px;
        border: 2px solid #e1e8ed;
        border-radius: 8px;
        font-size: 14px;
        transition: border-color 0.3s;
      }
      input:focus,
      select:focus {
        outline: none;
        border-color: #667eea;
      }
      .button-group {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 10px;
        margin-bottom: 20px;
      }
      button {
        padding: 14px 24px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 15px;
        font-weight: 500;
        cursor: pointer;
        transition:
          transform 0.2s,
          box-shadow 0.2s;
      }
      button:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
      }
      button:active {
        transform: translateY(0);
      }
      button.secondary {
        background: #f5f8fa;
        color: #333;
      }
      button.secondary:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }
      textarea {
        width: 100%;
        padding: 16px;
        border: 2px solid #e1e8ed;
        border-radius: 8px;
        font-family: "Monaco", "Courier New", monospace;
        font-size: 13px;
        resize: vertical;
        min-height: 180px;
      }
      textarea:focus {
        outline: none;
        border-color: #667eea;
      }
      .success-message {
        background: #d4edda;
        color: #155724;
        padding: 12px 16px;
        border-radius: 8px;
        margin-bottom: 20px;
        display: none;
      }

      /* åˆ†å‰²çº¿ */
      .divider {
        border: none;
        border-top: 2px solid #f0f0f0;
        margin: 32px 0;
      }

      /* Token åˆ—è¡¨åŒºåŸŸ */
      .list-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 16px;
      }
      .list-header h2 {
        font-size: 20px;
        color: #333;
      }
      .list-hint {
        font-size: 13px;
        color: #999;
      }

      /* ç­›é€‰ Tab */
      .filter-tabs {
        display: flex;
        gap: 8px;
        margin-bottom: 16px;
        border-bottom: 2px solid #f0f0f0;
        padding-bottom: 0;
      }
      .tab-btn {
        padding: 8px 18px;
        background: none;
        border: none;
        border-radius: 8px 8px 0 0;
        font-size: 14px;
        color: #666;
        cursor: pointer;
        font-weight: 500;
        border-bottom: 3px solid transparent;
        transform: none;
        box-shadow: none;
        transition:
          color 0.2s,
          border-color 0.2s;
        margin-bottom: -2px;
      }
      .tab-btn:hover {
        color: #667eea;
        transform: none;
        box-shadow: none;
      }
      .tab-btn.active {
        color: #667eea;
        border-bottom-color: #667eea;
      }

      /* è¡¨æ ¼ */
      .token-table-wrap {
        overflow-x: auto;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
      }
      th {
        background: #f8f9fc;
        color: #555;
        font-weight: 600;
        padding: 10px 12px;
        text-align: left;
        border-bottom: 2px solid #eee;
        white-space: nowrap;
      }
      td {
        padding: 10px 12px;
        border-bottom: 1px solid #f0f0f0;
        color: #444;
        vertical-align: middle;
      }
      tr:last-child td {
        border-bottom: none;
      }
      tr:hover td {
        background: #fafbff;
      }

      .token-cell {
        font-family: "Monaco", monospace;
        font-size: 11px;
        color: #667eea;
        word-break: break-all;
        max-width: 220px;
      }
      .copy-btn {
        padding: 3px 8px;
        font-size: 11px;
        border-radius: 4px;
        background: #f0f2ff;
        color: #667eea;
        border: 1px solid #c5cff8;
        cursor: pointer;
        transform: none;
        box-shadow: none;
        white-space: nowrap;
      }
      .copy-btn:hover {
        background: #667eea;
        color: white;
        transform: none;
        box-shadow: none;
      }

      /* çŠ¶æ€æ ‡ç­¾ */
      .badge {
        display: inline-block;
        padding: 3px 10px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
      }
      .badge-unused {
        background: #e8fdf5;
        color: #11998e;
      }
      .badge-used {
        background: #fff8e1;
        color: #e07b00;
      }
      .badge-expired {
        background: #ffeaea;
        color: #cb2d3e;
      }

      /* åˆ†é¡µ */
      .pagination {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        margin-top: 20px;
      }
      .page-btn {
        padding: 6px 14px;
        font-size: 13px;
        border-radius: 6px;
        background: #f5f8fa;
        color: #444;
        border: 1px solid #e0e0e0;
        cursor: pointer;
        transform: none;
        box-shadow: none;
      }
      .page-btn:hover {
        background: #667eea;
        color: white;
        border-color: #667eea;
        transform: none;
        box-shadow: none;
      }
      .page-btn.active {
        background: #667eea;
        color: white;
        border-color: #667eea;
      }
      .page-btn:disabled {
        opacity: 0.4;
        cursor: not-allowed;
      }
      .page-info {
        font-size: 13px;
        color: #888;
      }

      .empty-tip {
        text-align: center;
        padding: 40px;
        color: #bbb;
        font-size: 14px;
      }
      .list-loading {
        text-align: center;
        padding: 30px;
        color: #999;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ğŸ”‘ Tokenç®¡ç†å·¥å…·</h1>
      <p class="subtitle">å¿ƒç†æµ‹è¯„H5é¡¹ç›® - æ‰¹é‡ç”Ÿæˆ & æŸ¥çœ‹æµ‹è¯„é“¾æ¥</p>

      <!-- ç»Ÿè®¡å¡ç‰‡ï¼ˆç‚¹å‡»å¯ç­›é€‰ï¼‰ -->
      <div class="stats" id="stats">
        <div
          class="stat-card active"
          data-status="all"
          onclick="switchStatFilter('all')"
        >
          <div class="stat-number" id="totalCount">-</div>
          <div class="stat-label">å…¨éƒ¨</div>
        </div>
        <div
          class="stat-card"
          data-status="unused"
          onclick="switchStatFilter('unused')"
        >
          <div class="stat-number" id="unusedCount">-</div>
          <div class="stat-label">æœªä½¿ç”¨</div>
        </div>
        <div
          class="stat-card"
          data-status="used"
          onclick="switchStatFilter('used')"
        >
          <div class="stat-number" id="usedCount">-</div>
          <div class="stat-label">å·²ä½¿ç”¨</div>
        </div>
        <div
          class="stat-card"
          data-status="expired"
          onclick="switchStatFilter('expired')"
        >
          <div class="stat-number" id="expiredCount">-</div>
          <div class="stat-label">å·²è¿‡æœŸ</div>
        </div>
      </div>

      <!-- ç”Ÿæˆè¡¨å• -->
      <div class="form-group">
        <label for="templateId">æµ‹è¯„æ¨¡æ¿</label>
        <select id="templateId">
          <option value="perfume_test_v1">é¦™æ°´æ€§æ ¼æµ‹è¯„ v1</option>
        </select>
      </div>
      <div class="form-group">
        <label for="count">ç”Ÿæˆæ•°é‡ (1-100)</label>
        <input type="number" id="count" value="10" min="1" max="100" />
      </div>
      <div class="button-group">
        <button onclick="generateToken()">ğŸ¯ æ‰¹é‡ç”ŸæˆToken</button>
        <button class="secondary" onclick="refreshStats()">ğŸ”„ åˆ·æ–°ç»Ÿè®¡</button>
      </div>

      <div class="success-message" id="successMessage">
        âœ… å·²æˆåŠŸç”Ÿæˆ<span id="generatedCount"></span>ä¸ªTokenï¼
      </div>

      <div class="form-group">
        <label for="result">ç”Ÿæˆçš„é“¾æ¥ï¼ˆæ¯è¡Œä¸€ä¸ªï¼Œå¯ç›´æ¥å¤åˆ¶ç²˜è´´å‘é€ï¼‰</label>
        <textarea
          id="result"
          placeholder="ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®ç”ŸæˆTokené“¾æ¥..."
        ></textarea>
      </div>

      <hr class="divider" />

      <!-- Token åˆ—è¡¨ -->
      <div class="list-header">
        <h2>ğŸ“‹ Token åˆ—è¡¨</h2>
        <span class="list-hint" id="listHint"></span>
      </div>

      <div class="filter-tabs">
        <button class="tab-btn active" id="tab-all" onclick="switchTab('all')">
          å…¨éƒ¨
        </button>
        <button class="tab-btn" id="tab-unused" onclick="switchTab('unused')">
          æœªä½¿ç”¨
        </button>
        <button class="tab-btn" id="tab-used" onclick="switchTab('used')">
          å·²ä½¿ç”¨
        </button>
        <button class="tab-btn" id="tab-expired" onclick="switchTab('expired')">
          å·²è¿‡æœŸ
        </button>
      </div>

      <div id="listLoading" class="list-loading" style="display: none">
        â³ åŠ è½½ä¸­...
      </div>

      <div class="token-table-wrap" id="tableWrap">
        <table id="tokenTable">
          <thead>
            <tr>
              <th>Token</th>
              <th>çŠ¶æ€</th>
              <th>åˆ›å»ºæ—¶é—´</th>
              <th>è¿‡æœŸæ—¶é—´</th>
              <th>ä½¿ç”¨æ—¶é—´</th>
              <th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="tokenTbody"></tbody>
        </table>
        <div class="empty-tip" id="emptyTip" style="display: none">
          æš‚æ— æ•°æ®
        </div>
      </div>

      <div class="pagination" id="pagination"></div>
    </div>

    <script>
      const API_BASE = window.location.origin + "/api";
      let currentTab = "all";
      let currentPage = 1;
      const PAGE_SIZE = 20;

      window.addEventListener("load", () => {
        refreshStats();
        loadTokenList();
      });

      // ç»Ÿè®¡å¡ç‰‡ç‚¹å‡»ç­›é€‰
      function switchStatFilter(status) {
        document
          .querySelectorAll(".stat-card")
          .forEach((c) => c.classList.remove("active"));
        document
          .querySelector(`.stat-card[data-status="${status}"]`)
          .classList.add("active");
        switchTab(status);
      }

      // Tab åˆ‡æ¢
      function switchTab(status) {
        currentTab = status;
        currentPage = 1;
        document
          .querySelectorAll(".tab-btn")
          .forEach((b) => b.classList.remove("active"));
        document.getElementById(`tab-${status}`).classList.add("active");
        // åŒæ­¥ç»Ÿè®¡å¡ç‰‡é«˜äº®
        document
          .querySelectorAll(".stat-card")
          .forEach((c) => c.classList.remove("active"));
        document
          .querySelector(`.stat-card[data-status="${status}"]`)
          .classList.add("active");
        loadTokenList();
      }

      // åˆ·æ–°ç»Ÿè®¡
      async function refreshStats() {
        try {
          const res = await fetch(`${API_BASE}/admin/stats`);
          const data = await res.json();
          if (data.code === 200) {
            document.getElementById("totalCount").textContent = data.data.total;
            document.getElementById("unusedCount").textContent =
              data.data.unused;
            document.getElementById("usedCount").textContent = data.data.used;
            document.getElementById("expiredCount").textContent =
              data.data.expired;
          }
        } catch (e) {
          console.error("è·å–ç»Ÿè®¡å¤±è´¥:", e);
          alert("âš ï¸ æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œè¯·ç¡®ä¿åç«¯æœåŠ¡å·²å¯åŠ¨ï¼");
        }
      }

      // åŠ è½½ Token åˆ—è¡¨
      async function loadTokenList(page = currentPage) {
        currentPage = page;
        const loading = document.getElementById("listLoading");
        const tableWrap = document.getElementById("tableWrap");
        const emptyTip = document.getElementById("emptyTip");

        loading.style.display = "block";
        tableWrap.style.display = "none";

        try {
          const res = await fetch(
            `${API_BASE}/admin/tokens?status=${currentTab}&page=${page}&pageSize=${PAGE_SIZE}`,
          );
          const data = await res.json();
          loading.style.display = "none";

          if (data.code !== 200) throw new Error(data.message);

          const { list, total } = data.data;
          const hint = document.getElementById("listHint");
          hint.textContent = `å…± ${total} æ¡`;

          if (list.length === 0) {
            tableWrap.style.display = "block";
            document.getElementById("tokenTbody").innerHTML = "";
            emptyTip.style.display = "block";
            document.getElementById("tokenTable").style.display = "none";
            renderPagination(total);
            return;
          }

          emptyTip.style.display = "none";
          document.getElementById("tokenTable").style.display = "table";
          tableWrap.style.display = "block";

          const domain = window.location.origin;
          const tbody = document.getElementById("tokenTbody");
          tbody.innerHTML = list
            .map((t) => {
              const url = `${domain}/test?token=${t.token}`;
              const statusMap = {
                unused: "badge-unused",
                used: "badge-used",
                expired: "badge-expired",
              };
              const statusLabel = {
                unused: "æœªä½¿ç”¨",
                used: "å·²ä½¿ç”¨",
                expired: "å·²è¿‡æœŸ",
              };
              return `<tr>
              <td class="token-cell" title="${t.token}">${t.token.substring(0, 18)}â€¦</td>
              <td><span class="badge ${statusMap[t.status] || ""}">${statusLabel[t.status] || t.status}</span></td>
              <td>${formatDate(t.createdAt)}</td>
              <td>${formatDate(t.expiresAt)}</td>
              <td>${t.usedAt ? formatDate(t.usedAt) : "-"}</td>
              <td><button class="copy-btn" onclick="copyUrl('${url}')">å¤åˆ¶é“¾æ¥</button></td>
            </tr>`;
            })
            .join("");

          renderPagination(total);
        } catch (e) {
          loading.style.display = "none";
          tableWrap.style.display = "block";
          console.error("åŠ è½½Tokenåˆ—è¡¨å¤±è´¥:", e);
        }
      }

      // æ¸²æŸ“åˆ†é¡µ
      function renderPagination(total) {
        const totalPages = Math.ceil(total / PAGE_SIZE);
        const pg = document.getElementById("pagination");
        if (totalPages <= 1) {
          pg.innerHTML = "";
          return;
        }

        let html = `<button class="page-btn" onclick="loadTokenList(${currentPage - 1})" ${currentPage === 1 ? "disabled" : ""}>â€¹ ä¸Šä¸€é¡µ</button>`;
        const start = Math.max(1, currentPage - 2);
        const end = Math.min(totalPages, currentPage + 2);
        for (let i = start; i <= end; i++) {
          html += `<button class="page-btn ${i === currentPage ? "active" : ""}" onclick="loadTokenList(${i})">${i}</button>`;
        }
        html += `<button class="page-btn" onclick="loadTokenList(${currentPage + 1})" ${currentPage === totalPages ? "disabled" : ""}>ä¸‹ä¸€é¡µ â€º</button>`;
        html += `<span class="page-info">${currentPage} / ${totalPages} é¡µ</span>`;
        pg.innerHTML = html;
      }

      // æ ¼å¼åŒ–æ—¶é—´
      function formatDate(dateStr) {
        if (!dateStr) return "-";
        const d = new Date(dateStr);
        const pad = (n) => String(n).padStart(2, "0");
        return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
      }

      // å¤åˆ¶é“¾æ¥
      function copyUrl(url) {
        navigator.clipboard.writeText(url).then(() => {
          // ç®€å•æç¤º
          const tip = document.createElement("div");
          tip.textContent = "âœ… å·²å¤åˆ¶";
          Object.assign(tip.style, {
            position: "fixed",
            bottom: "30px",
            left: "50%",
            transform: "translateX(-50%)",
            background: "#333",
            color: "#fff",
            padding: "8px 20px",
            borderRadius: "20px",
            fontSize: "14px",
            zIndex: "9999",
            opacity: "1",
            transition: "opacity 0.5s",
          });
          document.body.appendChild(tip);
          setTimeout(() => {
            tip.style.opacity = "0";
            setTimeout(() => tip.remove(), 500);
          }, 1500);
        });
      }

      // ç”Ÿæˆ Token
      async function generateToken() {
        const templateId = document.getElementById("templateId").value;
        const count = parseInt(document.getElementById("count").value);
        const resultArea = document.getElementById("result");
        const successMsg = document.getElementById("successMessage");

        if (count < 1 || count > 100) {
          alert("ç”Ÿæˆæ•°é‡å¿…é¡»åœ¨1-100ä¹‹é—´");
          return;
        }

        resultArea.value = "â³ æ­£åœ¨ç”ŸæˆToken...";
        try {
          const res = await fetch(`${API_BASE}/admin/generate-token`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ templateId, count }),
          });
          const data = await res.json();
          if (data.code === 200) {
            resultArea.value = data.data.tokens.join("\n");
            document.getElementById("generatedCount").textContent = count;
            successMsg.style.display = "block";
            setTimeout(() => {
              successMsg.style.display = "none";
            }, 3000);
            refreshStats();
            loadTokenList();
            resultArea.select();
          } else {
            throw new Error(data.message);
          }
        } catch (e) {
          resultArea.value = "";
          alert("âŒ ç”Ÿæˆå¤±è´¥: " + e.message);
        }
      }
    </script>
  </body>
</html>
